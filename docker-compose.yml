# Docker Compose file for RAG Pipeline

services:
    etcd:
        container_name: milvus-etcd
        image: quay.io/coreos/etcd:v3.5.5
        environment:
            - ETCD_AUTO_COMPACTION_MODE=revision
            - ETCD_AUTO_COMPACTION_RETENTION=1000
            - ETCD_QUOTA_BACKEND_BYTES=4294967296
            - ETCD_SNAPSHOT_COUNT=50000
        volumes:
            - ./data/etcd:/etcd
        command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
        healthcheck:
            test: ["CMD", "etcdctl", "endpoint", "health"]
            interval: 30s
            timeout: 20s
            retries: 3
        networks:
            - rag-network

    minio:
        container_name: milvus-minio
        image: minio/minio:latest
        environment:
            MINIO_ROOT_USER: minioadmin
            MINIO_ROOT_PASSWORD: minioadmin
        ports:
            - "9000:9000"
            - "9001:9001"
        volumes:
            - ./data/minio:/data
        command: server /data --console-address ":9001"
        healthcheck:
            test:
                ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
            interval: 30s
            timeout: 20s
            retries: 3
        networks:
            - rag-network

    milvus:
        container_name: milvus-standalone
        image: milvusdb/milvus:v2.3.3
        command: ["milvus", "run", "standalone"]
        environment:
            ETCD_ENDPOINTS: etcd:2379
            MINIO_ADDRESS: minio:9000
            MINIO_ACCESS_KEY: minioadmin
            MINIO_SECRET_KEY: minioadmin
            MINIO_USE_SSL: false
            MINIO_BUCKET_NAME: milvus-bucket
        volumes:
            - ./data/milvus:/var/lib/milvus
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
            interval: 30s
            timeout: 20s
            retries: 3
            start_period: 90s
        ports:
            - "19530:19530"
            - "9091:9091"
        depends_on:
            - etcd
            - minio
        networks:
            - rag-network

    attu:
        container_name: milvus-attu
        image: zilliz/attu:v2.3.3
        environment:
            MILVUS_URL: milvus:19530
            HOST_URL: http://localhost:8000
            MILVUS_HOST: localhost
            MILVUS_PORT: 19530
        ports:
            - "8000:3000"
        depends_on:
            - milvus
        networks:
            - rag-network

    app:
        container_name: rag-app
        build:
            context: .
            dockerfile: Dockerfile
        ports:
            - "8080:8080"
        environment:
            - MINIO_ENDPOINT=minio:9000
            - MINIO_ACCESS_KEY=minioadmin
            - MINIO_SECRET_KEY=minioadmin
            - MINIO_SECURE=false
            - MILVUS_HOST=milvus
            - MILVUS_PORT=19530
            - PYTHONUNBUFFERED=1
        env_file:
            - .env
        volumes:
            - ./app:/app/app
            - ./logs:/app/logs
        depends_on:
            milvus:
                condition: service_healthy
            minio:
                condition: service_healthy
        networks:
            - rag-network
        restart: unless-stopped

networks:
    rag-network:
        driver: bridge
        name: rag-network

volumes:
    etcd-data:
    minio-data:
    milvus-data:
